/* *********************************************** Program iniciates with the parameter:* Help:* SuperWavApp -h** As a Server:* SuperWavApp -S -P PortNumber** As a Client:* SuperWavApp -C -IP IPDirecction -P PortNumber* *********************************************** */#include <stdio.h>#include "./lib/connection/client.h"#include "./lib/connection/server.h"#include "./lib/connection/pipe.h"#include "./lib/sound/spatiallib.h"#include "./lib/sound/superwavlib.h"void playSuperWav(long long timeToStart, int flag ,int pfd[]) {    while (TRUE){        if( (timeToStart - current_timestamp()) <= 0 ){            /* Fork a child process. */            switch (fork()) {                case (pid_t) -1: /* Fork failed. */                    fprintf(stderr, "Call to fork failed.\n");                    exit(1);                case 0: /* Child process. */                    closeWritingPipe(pfd);                    superWav(pfd,flag);                    exit(0);                default: /* Parent process. */                    closeReadingPipe(pfd);                    break;            } /* End of switch. */            break;        }/*else esperando*/    }}void notifyClients(ServerConnection server, long long timeToStart, int flag){    int i, pid;    printf("Time to start: %lld\n",timeToStart);    for (i = 0; i < server.max_clients; i++)    {        if (server.newSocketFileDescriptor[i]!= 0){            //printf("Connection, cont = %d, %d \n",i, server.newSocketFileDescriptor[i]);            /*eliminar fork y hacerlo desde el proceso padre*/            pid = fork();            if (pid < 0) {                error("ERROR on fork");            }            if (pid == 0) {                /*Cierro tubería ya que no se utiliza en los                 * precesos de recepción de mensaje*/                //closePipeFileDescriptor(pdf);                Close(server.socketFileDescriptor);                if (timeToStart > 0){                    sendTimeToStart(server.newSocketFileDescriptor[i],timeToStart);                }/*else{                    printf("\n¡¡No envío timestamp!!\n");                }*/                sleep(1);                sendFlag(server.newSocketFileDescriptor[i],flag);                exit(0);            }        }    }}/**********************************************************************//* START SERVER *//**********************************************************************/int startServerConnection(int portNumber, int flag){    int sd,max_sd;    int cont = 0;    int server_flag = flag;    int client_flag = changeFlag(flag);    int playing = FALSE;    ServerConnection server = startConfigurationServer(portNumber);    /* Pipe’s file descriptors. */    /* Set up pipe. */    int *pfd = startPipeFileDescriptor();    /* For select */    fd_set readfds;    struct timeval timeout;    int rv;    //clear the socket set    FD_ZERO(&readfds);    //add our file descriptor to the set    FD_SET(server.socketFileDescriptor, &readfds);    max_sd = server.socketFileDescriptor;    cont = cont+1;    timeout.tv_sec = 1;    timeout.tv_usec = 0;    /* ************************************* */    while(1) {        int search = TRUE;        if(search){            sd = server.newSocketFileDescriptor[cont];            //if valid socket descriptor then add to read list            if (sd > 0)                FD_SET(sd, &readfds);            //highest file descriptor number, need it for the select function            if (sd > max_sd)                max_sd = sd;            rv = Select(server.socketFileDescriptor + cont, &readfds, NULL, NULL, &timeout);            if (rv == -1) {                perror("select error"); /// an error accured                return 1;            }            else if (rv == 0) {                //printf(" ************************** timeout occurred (1 second) **************************\n"); // a timeout occured                //return 1;                timeout.tv_sec = 1;                timeout.tv_usec = 0;                /*Hay que inicializar estos datos cada vez que se utiliza resetea la configuración*/                //add our file descriptor to the set                FD_SET(server.socketFileDescriptor, &readfds);                /**/            }            else {                if (FD_ISSET(server.socketFileDescriptor, &readfds)) {                    server.newSocketFileDescriptor[cont] = Accept(server.socketFileDescriptor,                                                                  (struct sockaddr *) &server.cli_addr,                                                                  &server.clientLenght);                    //inform user of socket number - used in send and receive commands                    printf("New connection , socket fd is %d , ip is : %s , port : %d \n",                           server.newSocketFileDescriptor[cont], inet_ntoa(server.cli_addr.sin_addr),                           ntohs(server.cli_addr.sin_port));                }                cont += 1;            }        }        if (kbhit()) {            char c = getchar();            switch (c) {                case 's':                    if(playing){                        printf("\nAlready playing!\n");                    }else{                        search = FALSE;                        playing = TRUE;                        printf("\nSTART Music in 10 seconds !\n");                        long long timeToStart = timeToStartInSeconds(10);                        // clients of time to start                        notifyClients(server, timeToStart,client_flag);                        playSuperWav(timeToStart,server_flag,pfd);                    }                    break;                case 'p':                    client_flag = changeFlag(client_flag);                    server_flag = changeFlag(server_flag);                    notifyClients(server,0,client_flag);                    sleep(1);                    sendingFlag(pfd,server_flag);                    break;                case 'e':                    notifyClients(server,0,-1);                    closeWritingPipe(pfd);                    exit(0);                default:                    printf("\n Has presionado %c\n", c);            }        }    }    return 0;}/**********************************************************************//* FIN SERVER *//**********************************************************************//**********************************************************************//* START CLIENT *//**********************************************************************/int startClientConnection(char *address, int portNumber){    int                 bytes;    char                buffer[256];    ClientConnection    client  = startConfigurationClient(address, portNumber);    int *pfd = startPipeFileDescriptor();    bzero(buffer,256);    bytes = Recv(client.socketFileDescriptor,buffer,256,0);    printf("Milliseconds message recived: %lld\n", current_timestamp());    long long int timeToStart = atoll(buffer);    long long delay = (timeToStart-10000) - current_timestamp();    printf("Moment to start: %lld\n",atoll(buffer));    printf("Delay (10s program): %lld\n",delay);    bzero(buffer,256);    bytes = Recv(client.socketFileDescriptor,buffer,256,0);    int flag = atoll(buffer);    playSuperWav(timeToStart,flag,pfd);    for(;;) {        bzero(buffer, 256);        bytes = Recv(client.socketFileDescriptor, buffer, 255, 0);        if(bytes>0){            int newflag = atoll(buffer);            if(flag>=0){                if(newflag != flag){                    flag = newflag;                    sendingFlag(pfd,flag);                    //printf("Milliseconds message Recived: %lld\n", current_timestamp());                }/*Mientras nada nuevo*/            }            if(newflag == -1){                printf("\nSe acabo!!\n");                closeWritingPipe(pfd);                exit(0);            }        }    }    close(client.socketFileDescriptor);    return 0;}/**********************************************************************//* FIN CLIENT *//**********************************************************************/char *IP = NULL;int portNumber = NULL;int flag = NULL; int main(int argc, char *argv[]) {    if (argc < 2) {        printf("Wrong use of the program! "                "For help use -h option.\n");        exit(-1);    }    /*For Help*/    if ( (argc == 2) && ( strcmp(argv[1], "-h") == 0 ) ) {        printf("To use the program:\n"                "As a Server:\n"                "SuperWavApp -S -P <PortNumber>\n"                "\n"                "As a Client:\n"                "SuperWavApp -C -IP <IPDirecction> -P <PortNumber>\n");        exit(0);    }    /*If Server*/    if ( (argc >= 3) && ( strcmp(argv[1], "-S") == 0 ) ) {        if ( (argc == 4) && ( strcmp(argv[2], "-P") == 0) ) {            portNumber = atoi(argv[3]);            printf("\n***********************\n"                            "Port Number: %d\n"                            "***********************\n"                    ,portNumber);            /****************************************/            /*Server Scocket iniciación and configuration*/            //ServerConnection server = startConfigurationServer(portNumber);            flag = TRUE;            startServerConnection(portNumber,flag);            /****************************************/        }        else {            printf("Wrong use of the program! "                    "For help use -h option.\n"                    "SuperWavApp -S -P <PortNumber>\n");            exit(-1);        }    }    /*If Client*/    if (( argc >= 3) && ( strcmp(argv[1], "-C") == 0) ) {        if ( (argc == 6) && ( strcmp(argv[2],"-IP") == 0) && (strcmp(argv[4], "-P") == 0) ) {            IP = argv[3];            portNumber = atoi(argv[5]);            printf("\n***********************\n"                            "IP Direction: %s\n"                            "Port Number: %d\n"                            "***********************\n",                    IP,portNumber);            /****************************************/            /*Client Scocket iniciación and configuration*/            //ClientConnection client = startConfigurationClient(IP,portNumber);            startClientConnection(IP,portNumber);            /****************************************/        }        else {            printf("Wrong use of the program! "                    "For help use -h option.\n"                    "SuperWavApp -C -IP <IPDirecction> -P <PortNumber>\n");            exit(-1);        }    }}